/*! monex v0.9.18-SNAPSHOT | (c) 2019  | LGPL-2.1-only License | git+https://github.com/eXist-db/monex.git */
function findByName(e,t){if(e instanceof Array)for(var n=0;n<e.length;n++)if(e[n].name()===t)return e[n];return null}function addKillBtn(e,t){$(e).find(".kill-query").click((function(e){e.preventDefault(),0===JMX_INSTANCE.version?$.ajax({url:"modules/admin.xql",data:{action:"kill",id:t.id()},type:"POST"}):JMX.connection.invoke("killQuery","org.exist.management.exist:type=ProcessReport",[t.id()])}))}function uptime(e){var t=parseInt(e),n=864e5,o=Math.floor(t/n),s="0"+Math.floor((t-o*n)/36e5),a="0"+Math.round((t-o*n-36e5*s)/6e4);return status=0<o?o+"d "+s.substr(-2)+"h":s.substr(-2)+"h "+a.substr(-2)+"m",status}JMX.TimeSeries=(function(){var i={series:{lines:{show:!0,lineWidth:1.2,fill:!0}},xaxis:{mode:"time",show:!0,tickSize:[2,"second"],tickFormatter:function(e,t){var n=new Date(e);return n.getSeconds()%20!=0?"":(n.getHours()<10?"0"+n.getHours():n.getHours())+":"+(n.getMinutes()<10?"0"+n.getMinutes():n.getMinutes())+":"+(n.getSeconds()<10?"0"+n.getSeconds():n.getSeconds())},axisLabel:"Time",axisLabelUseCanvas:!1,axisLabelFontSizePixels:12,axisLabelFontFamily:"Verdana, Arial",axisLabelPadding:10},yaxis:{min:0,max:100,axisLabelUseCanvas:!0,axisLabelFontSizePixels:12,axisLabelFontFamily:"Verdana, Arial",axisLabelPadding:6},legend:{show:!0,labelBoxBorderColor:"#fff"}};function r(e,t){if(!e)return 0;for(var n=t.split("."),o=e,s=0;s<n.length&&o.hasOwnProperty(n[s]);s++)o=o[n[s]];return o||0}return Constr=function(e,t,n,o,s){this.container=$(e),this.properties=n,this.propertyMaxY=o,this.unitY=s,this.dataset=[];for(var a=0;a<t.length;a++)this.dataset.push({label:t[a],data:[]})},Constr.prototype.update=function(e){var t=parseInt(r(e,this.propertyMaxY));if("mb"===this.unitY&&(t=t/1024/1024),i.yaxis.max=t,100<this.dataset[0].data.length)for(var n=0;n<this.dataset.length;n++)this.dataset[n].data.shift();for(var o=(new Date).getTime(),s=0;s<this.properties.length;s++){var a=r(e,this.properties[s]);"mb"===this.unitY&&(a=parseInt(a)/1024/1024),this.dataset[n].data.push([o,parseInt(a)])}$.plot(this.container,this.dataset,i)},Constr})(),JMX.connection=(function(){"use strict";var r,t,a=null,c={},n=!0,i=1e3;function l(e,t){this.name=ko.observable(e.name),this.url=ko.observable(e.url),this.baseURL=e.url,this.token=e.token;var n=t?e.status:"Stopped";"Checking"===n||"PING_OK"===n||"Stopped"===n?(this.status=ko.observable(n),this.message=ko.observable("")):(this.message=ko.observable(n),this.status=ko.observable("PING_ERROR")),this.elapsed=ko.observable("00:00.000"),this.time=ko.observable("0"),this.icon=ko.computed((function(){switch(this.status()){case"Checking":return"fa fa-refresh primary";case"PING_OK":return"fa fa-check-circle-o success";default:return"fa fa-warning danger"}}),this)}function u(e,t){this.instances=ko.observableArray(e),this.status=ko.observable(t?"Checking":"Stopped"),this.warnings=ko.computed((function(){for(var e=0,t=0;t<this.instances().length;t++){var n=this.instances()[t].status();"PING_ERROR"!==n&&"Connection Error"!==n||e++}return 0===e?"":e}),this),this.schedule=function(){var t=this,n="Stopped"===t.status()?"Checking":"Stopped";t.status(n),$.ajax({url:"modules/"+("Stopped"==n?"unschedule.xql":"schedule.xql"),method:"GET",success:function(){for(var e=0;e<t.instances().length;e++)t.instances()[e].status(n)}})}}return{invoke:function(o,e,t){var n;if(n="localhost"===r.name()?location.pathname.replace(/^(.*?)\/(apps\/)?monex\/.*$/,"$1")+"/status?operation="+o+"&mbean="+e+"&token="+r.token:"modules/remote.xql?operation="+o+"&mbean="+e+"&name="+r.name(),t)for(var s=0;s<t.length;s++)n+="&args="+t[s];$.ajax({url:n,type:"GET",timeout:1e4,error:function(e,t,n){$("#connection-alert").show(400).find(".message").text("Operation '"+o+"' failed or is not supported on this server instance."),setTimeout((function(){$("#connection-alert").hide(200)}),3e3)}})},poll:function(o){if(t=o,n){var e,s=r.name();e="localhost"===s?location.pathname.replace(/^(.*?)\/(apps\/)?monex\/.*$/,"$1")+"/status?c=instances&c=processes&c=locking&c=memory&c=caches&c=system&c=operatingsystem&token="+r.token:"modules/remote.xql?name="+s,$.ajax({url:e,type:"GET",timeout:1e4,success:function(e){$("#connection-alert").hide(400);var t=JMX.util.fixjs(JMX.util.jmx2js(e));if(t){t.jmx.version||(t.jmx.version=0),r.version=t.jmx.version;var n=document.getElementById("dashboard");n&&(a?ko.mapping.fromJS(t,a):((a=ko.mapping.fromJS(t)).gc=function(){JMX.connection.invoke("gc","java.lang:type=Memory")},t.jmx.ProcessReport.TrackRequestURI?($("#threshold").val(t.jmx.ProcessReport.MinTime),$("#track-uri").prop("checked","true"===t.jmx.ProcessReport.TrackRequestURI),$("#history-timespan").val(t.jmx.ProcessReport.HistoryTimespan)):$("#configure-history").hide(),a.url="localhost"===s?"":r.url().replace(/\/exist\/?$/,""),ko.applyBindings(a,n))),o&&o(t),setTimeout((function(){JMX.connection.poll(o)}),i)}else $("#connection-alert").show(400).find(".message").text("No response from server. Retrying ..."),setTimeout((function(){JMX.connection.poll(o)}),5e3)},error:function(e,t,n){$("#connection-alert").show(400).find(".message").text("Connection to server failed. Retrying ..."),setTimeout(JMX.connection.poll,5e3)}})}},init:function(e,t){c={};for(var n=[],o=0;o<e.length;o++){var s=new l(e[o],t);c[e[o].name]=s,e[o].name===JMX_INSTANCE&&(r=s),"local"!==e[o].url&&n.push(s)}var a=new u(n,t),i=document.getElementById("remotes");i&&ko.applyBindings(a,i),ko.applyBindings(a,$("#notifications")[0]),(function(e,n){if(!Modernizr.websockets)return $("#browser-alert").show(400),setTimeout((function(){$("#browser-alert").hide(200)}),8e3);var t=location.pathname.replace(/^(.*?)\/(apps\/)?monex\/.*$/,"$1"),o=("https:"===window.location.protocol?"wss":"ws")+"://"+location.host+t+"/rconsole",s=new WebSocket(o);s.onerror=function(e){$("#status").text("Connection error ..."),console.log("WebSocket Error: %o",e)},s.onclose=function(){$("#status").text("Disconnected.")},s.onopen=function(){$("#status").text("Connected."),s.send('{ "channel": "'+e+'" }')},s.onmessage=function(e){if("ping"!==e.data){var t=JSON.parse(e.data);console.log("ping received for %s: %s",t.instance,t.status),n(t)}}})("jmx.ping",JMX.connection.ping)},ping:function(e){var t=c[e.instance];if(t)switch(t.elapsed(e.elapsed),e.status){case"ok":t.status(e.SanityReport.Status),t.time(e.SanityReport.PingTime),t.message("");break;case"pending":t.status("Checking"),t.time("?"),t.message("");break;default:t.status("PING_ERROR"),t.message(e.status),t.time("?")}else console.log("instance not found: %s",e.instance)},setPollPeriod:function(e){i=1e3*parseFloat(e)},togglePolling:function(){n?n=!1:(n=!0,JMX.connection.poll(t))}}})(),$((function(){JMX.connection.init(JMX_INSTANCES,JMX_ACTIVE),$("#configure").click((function(e){e.preventDefault();var t=$("#threshold").val(),n=$("#history-timespan").val(),o=$("#track-uri").is(":checked");JMX.connection.invoke("configure","org.exist.management.exist:type=ProcessReport",[t,n,o])})),$("#dashboard").each((function(){var a=[];$(".chart").each((function(){var e=$(this),t=e.attr("data-labels"),n=e.attr("data-properties"),o=e.attr("data-unit-y")||"",s=e.attr("data-max-y");a.push(new JMX.TimeSeries(e,t.split(","),n.split(","),s,o))})),$("#poll-period").ionRangeSlider({min:.5,max:60,from:1,type:"single",step:.1,postfix:" sec",hasGrid:!0,onChange:function(e){JMX.connection.setPollPeriod(e.from)}}),$("#pause-btn").click((function(e){JMX.connection.togglePolling()})),JMX.connection.poll((function(e){for(var t=0;t<a.length;t++)a[t].update(e);$(".stack").popover({placement:"auto right",html:!0,container:"#dashboard",trigger:"focus",template:'<div class="popover stacktrace" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><pre class="popover-content"></pre></div>'})}))}))}));